# FPM‑A: Фазово‑режимна модель для ринкових стратегій

> **Мета.** Дати практичне, відтворюване пояснення методології FPM‑A (Phase/Regime Model — версія A) та її інтеграції в пайплайн TradePulse.

---

## 1) Що таке FPM‑A

**FPM‑A** — це прикладна методологія розкладання ринку на дискретні **фази/режими** з подальшим навчанням/налаштуванням окремих моделей, правил ризик‑менеджменту та сигналів **для кожної фази**. На відміну від «моно‑моделі» зі статичними параметрами, FPM‑A робить два кроки:

1. **Детекція фази:** оцінка поточних і перехідних ймовірностей режимів (волатильність, кореляції, ліквідність, макро‑стани).
2. **Фазова оркестрація:** вибір/мікшування моделей, лімітів ризику та тактик виконання під активну фазу.

Термін «фаза» тут **еквівалентний** «режиму» (bull/bear, турбулентний/спокійний, risk‑on/risk‑off тощо) і базується на формальних статистичних моделях (HMM/Markov‑switching, jump/пресистентні режими) і фазових ознаках сигналів (миттєва фаза Гільберта, EMD/CEEMD, індекси синхронізації).

---

## 2) Навіщо: доказова база з літератури

Багато емпіричних робіт показують, що **режимні/фазові** підходи знижують просідання та/або покращують ризик‑прибутковість порівняно зі статичними стратегіями. Ключові результати (коротко):

* Регім‑базована оптимізація (HMM + MPC) дає **вищі Sharpe/Calmar** і **менші MDD** за buy‑and‑hold на MSCI World, S&P 500, TOPIX, DAX, FTSE, MSCI EM (таблиці з цифрами див. у розділі 7).
* RS‑моделі (Ang & Bekaert/Guidolin & Timmermann) демонструють, що ігнорування режимів призводить до субоптимальної диверсифікації; оптимальні портфелі **істотно відрізняються** між «bull» і «bear» станами.
* Марковські стратегії у реалістичних тестах показують **прибутковість після витрат** і **~40% зменшення волатильності**; турбулентність‑скейлінг підвищує стійкість портфелів.

> **У висновку:** FPM‑A спирається на доведену практику — спершу визначити фазу, потім застосувати спеціалізовані моделі/ліміти під цю фазу.

---

## 3) Архітектура FPM‑A у TradePulse

### 3.1. Шари системи

* **DataOps:** ціни (OHLCV), макро (FRED/ECB), ринкова мікроструктура, фактори/альфи.
* **Phase Engine:**

  * *Детермінанти фази*: волатильність (realized/est. GARCH), кореляційна структура (PCA/Absorption Ratio), ліквідність (спреди/обсяги), макро‑індикатори, новини‑ризики.
  * *Моделі фаз*: HMM / Markov‑switching, jump‑регім, hazard‑моделі переходів, фазові ознаки (EMD/Hilbert‑phase, синхронізація).
* **Policy Layer:** набір експертів (класифікатор тренду, волатильності, сигналів входу/виходу), позиціювання (леверидж/кеш), стопи/тейки.
* **Execution & RM:** ліміти по фазі, тушіння ризику, контролі за кількістю угод, ковзання, TCA.

### 3.2. Контракти між шарами

* `PhaseState` = {id, p(state), features, ttl}
* `PhasePolicy[state]` = {model_id, params, risk_limits, sizing_fn}
* `Decision` = {target_weights, risk_overrides, commentary}

---

## 4) Каталог фаз (референс)

| Код    | Коротка назва     | Опис                                       | Типові ознаки                             | Політика ризику                        |
| ------ | ----------------- | ------------------------------------------ | ----------------------------------------- | -------------------------------------- |
| **S1** | Спокійний bull    | Низька σ, позитивні μ, стабільні кореляції | низький TI, низький AR/PCA, вузькі спреди | більше ризику, тренд‑фол.              |
| **S2** | Волатильний bull  | Висока σ, μ ≥ 0                            | σ↑, кореляції↑                            | помірний леверидж, часткове кешування. |
| **S3** | Турбулентний bear | Висока σ, μ < 0, кореляції «аномальні»     | TI/Absorption Ratio↑↑                     | скорочення експозиції, кеш/хедж.       |
| **S4** | Відновлення       | σ знижується, μ → +                        | перехідні ймовірності → S1                | поступове нарощування ризику.          |

> TI = Turbulence Index; AR/PCA = Absorption Ratio/внесок головних компонент.

---

## 5) Ознаки та детектори фази

* **Волатильність:** realized (Parkinson/Garman‑Klass), EWMA, GARCH; квантили/кластеризація.
* **Кореляційна геометрія:** ковараційна матриця, **Absorption Ratio**, Mahalanobis‑«турбулентність»; моніторинг «незвичності» кореляцій.
* **Фазові ознаки сигналів:** EMD/CEEMD → IMFs → **миттєва фаза (Гільберт)** → індекси синхронізації між активами/факторами; крос‑рекурентні метрики.
* **Марковські/HMM:** 2–4 стани, online‑адаптація, стійкі оцінки перехідних матриць; варіант — jump‑режими з penalty на часті перемикання.
* **Макро/ліквідність:** FRED‑MD/ЄЦБ, спреди, обсяги, крос‑активні індикатори стресу.

---

## 6) Оркестрація політик

* **Маршрутизація:** `argmax p(state)` або енсамблеве мікшування, якщо p розмазане.
* **Моделі per‑state:**

  * S1: тренд/перенавчання на низьку σ; ширші тейк‑профіти.
  * S3: анти‑тренд/мін‑вар портфелі, стопи коротші, валютні/облігаційні хеджи.
* **Ризик‑менеджмент:** фазові ліміти на леверидж, VaR/ETL таргети, ліміти просідання, обмеження обороту.

---

## 7) Репродукція результатів (мін. приклади)

> Резюме даних з відтворюваних досліджень; ці значення можна покласти в `README.md → Results`.

**HMM+MPC vs Buy‑and‑Hold (1998–2015, щоденні дані):**

| Індекс     | AR (MPC vs B&H) | SD           | Sharpe       | MDD          |
| ---------- | --------------- | ------------ | ------------ | ------------ |
| MSCI World | 0.076 vs 0.056  | 0.12 vs 0.18 | 0.65 vs 0.30 | 0.26 vs 0.57 |
| S&P 500    | 0.110 vs 0.108  | 0.14 vs 0.16 | 0.79 vs 0.68 | 0.36 vs 0.55 |
| TOPIX      | 0.044 vs 0.025  | 0.17 vs 0.24 | 0.26 vs 0.10 | 0.48 vs 0.72 |
| DAX        | 0.066 vs 0.073  | 0.16 vs 0.22 | 0.41 vs 0.33 | 0.39 vs 0.73 |
| FTSE       | 0.051 vs 0.078  | 0.14 vs 0.15 | 0.36 vs 0.54 | 0.36 vs 0.48 |
| MSCI EM    | 0.119 vs 0.072  | 0.18 vs 0.27 | 0.66 vs 0.27 | 0.38 vs 0.65 |

**Марковська алокація (позамірні тести):** зменшення волатильності **≈41%**; річний надлишковий прибуток **+0.185–2.016%** після витрат; відсікання високоволатильних фаз.

**RS у глобальних портфелях:** у присутності режимів оптимальні портфелі **істотно зміщуються** (частіше — у кеш/облігації під стійкий bear), і **домінують** статичні підходи out‑of‑sample.

> Примітка: наведені числа — з відтворюваних джерел; власні бек‑тести TradePulse слід будувати у такій самій методології (data‑split, транзакційні витрати, затримка виконання, обмеження на шорти тощо).

---

## 8) Протокол бектесту FPM‑A у TradePulse

1. **Дані:** N‑річні щоденні/годинні таймфрейми; включити корпоративні дії; нормалізація таймзон.
2. **Розбиття:** 2 роки ініціалізації + rolling out‑of‑sample; walk‑forward; одно- або мульти‑активні індекси.
3. **Витрати/фрікція:** комісії, спреди, проскальзування; затримка T+1; ліміти обороту.
4. **Обмеження:** long‑only або з контрольованими шортами; леверидж ≤ фазовий ліміт.
5. **Метрики:** AR, SD, **Sharpe**, **Calmar**, **MDD**, Turnover; стійкість за субперіодами.
6. **Контроль лукапу:** фіксація лише ex‑ante доступних ознак; відокремлення вибору гіперпараметрів.

---

## 9) Інтерфейси та псевдокод

```python
# Псевдо‑інтерфейси
class PhaseEngine:
    def fit(self, df): ...  # навчає HMM/детектори, повертає моделі
    def infer(self, df_t): ...  # повертає p(state), features

class PolicyRouter:
    def route(self, phase_state): ...  # вибір моделі/лімітів

# Основний цикл
for t in timeline:
    p_state, feats = phase_engine.infer(df[:t])
    decision = router.route(PhaseState(p_state, feats))
    execute(decision)
```

---

## 10) Обмеження та зауваги

* Ризик **над‑перемикання**: застосовуємо penalty/інерцію переходів.
* Стабільність ознак: перевірка дрейфу (PCA‑геометрія, TI‑квантили).
* Універсальність фаз: різні активи можуть потребувати різних карт фаз.

---

## 11) Далі

* Додати `docs/fpm-a/recipes/` із робочими зошитами: HMM детектор, TI/AR, EMD/Гільберт‑фаза, приклади політик S1–S4.
* Автоматизувати репорти «Results & Screenshots» (`scripts/report_fpm_a.py`).

---

## 12) Література (dobro‑надійні джерела)

* Ang, A., Bekaert, G. (2004). *How Regimes Affect Asset Allocation*. Financial Analysts Journal.
* Guidolin, M., Timmermann, A. (2008). *International Asset Allocation under Regime Switching, Skew and Kurtosis Preferences*. Review of Financial Studies.
* Nystrup, P., Madsen, H., Lindström, E. (2017). *Dynamic Portfolio Optimization Across Hidden Market Regimes*. Quantitative Finance (to appear; accepted version).
* Bulla, J., et al. (2010/2011). *Markov‑switching Asset Allocation: Do Profitable Strategies Exist?* Journal of Asset Management / MPRA.
* Kritzman, M., Li, Y. (2010). *Skulls, Financial Turbulence, and Risk Management*. Financial Analysts Journal.
* Kinlaw, W., Turkington, D., et al. (2013). *Correlation Surprise / Absorption Ratio* (J. Asset Management / JPM insights).
* Wu, M.C., et al. (2006). *Phase distribution and phase correlation of financial time series*. Physical Review E.
* Leung, T., Zhao, T. (2021). *Financial Time Series Analysis with HHT/CEEMD* (arXiv).
* Sultornsanee, S., et al. (2011). *Phase Synchronization in Stock Networks* (Procedia Computer Science).
