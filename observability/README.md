# Observability as Code

This directory captures the TradePulse observability stack as versioned code. All
metrics, alert rules, and dashboards live alongside the application source so
that monitoring environments can be reproduced in a deterministic manner.

## Layout

- `metrics.json` – canonical catalogue of Prometheus metrics exported by
  TradePulse services. The file documents allowed labels, metric types, and the
  owning subsystem.
- `alerts.json` – declarative Prometheus alert rule groups with severity and
  ownership metadata.
- `dashboards/` – Grafana dashboard definitions stored as JSON. Each file must
  declare a stable `uid` and at least one panel.
- `generated/` – build artefacts generated by the `observability.builder` tool.
- `logging/` – Filebeat and Logstash configuration for shipping container logs
  into Elasticsearch.
- `health_monitor.py` – reusable scheduler that keeps `HealthServer` state
  up-to-date via periodic probes.

## Building the bundle

Use the helper script to compile the definitions into consumable artefacts:

```bash
python -m tools.observability.builder --output-dir observability/generated
```

Running the command performs the following steps:

1. Validates that every metric uses a supported Prometheus type and unique name.
2. Ensures alert expressions reference known metrics and produce Prometheus rule
   files under `observability/generated/prometheus/alerts.yaml`.
3. Formats dashboards with stable JSON ordering under
   `observability/generated/dashboards/`.
4. Produces `manifest.json` with a concise summary of the bundle.

Include the generated directory when packaging infrastructure manifests or
shipping dashboards to Grafana so that staging and production remain in sync.

## Integrating with the Elastic Stack

`docker-compose.yml` now provisions Elasticsearch, Logstash, Filebeat, and
Kibana alongside the TradePulse services. Launch the stack with:

```bash
docker compose up tradepulse prometheus elasticsearch logstash kibana filebeat
```

Application logs emitted as JSON are collected automatically thanks to the
Filebeat autodiscover rules. Kibana dashboards can be built on top of the
`tradepulse-logs-*` index pattern.

## Automated Health Monitoring

Use `observability.health_monitor.PeriodicHealthMonitor` together with the
helpers in `observability.health_checks` to continuously evaluate ingestion,
signal generation, and execution subsystems. The monitor feeds status back into
`HealthServer` and emits Prometheus metrics so alerting rules can track probe
latency and outcomes.
